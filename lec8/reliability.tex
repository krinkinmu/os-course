\begin{frame}
\frametitle{Надежность файловых систем}
\begin{itemize}
  \item<1-> От файловых систем часто ожидают надежного хранения:
    \begin{itemize}
      \item толерантность к ошибкам диска;
      \item возможность переживать fail-stop-ы (например, сбои питания);
    \end{itemize}
  \item<2-> Решение первой проблемы - дублирование
    \begin{itemize}
      \item и возможно детектировать ошибки, без этого дублирование не работает;
      \item мы не будем останваливаться на этом подробнее;
    \end{itemize}
  \item<3-> Вторая проблема имеет несколько "решений":
    \begin{itemize}
      \item fsck;
      \item журналирование;
      \item COW;
    \end{itemize}
\end{itemize}
\end{frame}

\begin{frame}
\frametitle{Пример}
\begin{itemize}
  \item<1-> Рассмотрим как происходит создание файла в ФС:
    \begin{itemize}
      \item необходимо выделить место под данные (если он есть);
      \item необходимо выделить inode (например, выставить бит в битовой карте);
      \item добавить имя файла в родительский каталог;
    \end{itemize}
  \item<2-> В зависимости от порядка записи в случае fail-stop-а может случиться плохое или очень плохое:
    \begin{itemize}
      \item очень плохое: inode хранящий мусор и ведущий в никуда;
      \item плохое: inode занят, но не доступен (утечка);
    \end{itemize}
\end{itemize}
\end{frame}

\begin{frame}
\frametitle{fsck}
\begin{itemize}
  \item<1-> fsck - утилита, сканирующая ФС в поисках ошибок и исправляющая их;
    \begin{itemize}
      \item например, мы можем легко найти и исправить следующие ошибки:
         \begin{itemize}
           \item неправильный супер блок (boot block);
           \item утечки inode и блоков диска;
         \end{itemize}
    \end{itemize}
  \item<2-> fsck - прямолинейный и неэффективный способ:
    \begin{itemize}
      \item fsck - сканирует всю ФС, что не быстро;
      \item некоторые ошибки не легко исправить, даже если вы их нашли;
      \item из личного опыта - однажды fsck спас меня там, где не смогли справиться более продвинутые методы;
    \end{itemize}
\end{itemize}
\end{frame}

\begin{frame}
\frametitle{Журналирование}
\begin{itemize}
  \item<1-> Журналирование (write-ahead logging) - логирование операций перед их выполнением
    \begin{itemize}
      \item перед выполнением операции мы записываем ее описание в специальное место диска - журнал;
      \item после выполнения операции мы удаляем запись из журнала (помечаем как выполненую);
      \item после fail-stop нужно "проиграть" записи из журнала;
    \end{itemize}
  \item<2-> Записи в журнале должны быть идемпотентными:
    \begin{itemize}
      \item например, запись "аллоцировать inode" не идемпотентна;
      \item запись "записать в блок B данные X" идемпотентна;
      \item т. е. запись нужно уметь проиграть несколько раз;
    \end{itemize}
\end{itemize}
\end{frame}

\begin{frame}
\frametitle{Журналирование}
\begin{itemize}
  \item<1-> Фактически журналирование приводит к дублирование каждой записи
    \begin{itemize}
      \item зачастую журналируются только обновления метаданных, но не данных;
      \item запись в журнал всегда происходит последовательно;
    \end{itemize}
  \item<2-> Журнал - маленькая fail-stop безопасная ФС:
    \begin{itemize}
      \item мы можем записать что-то в журнал, а потом прочитать (не без сложностей);
      \item а не можем ли мы всю файловую систему построить как журнал?
    \end{itemize}
\end{itemize}
\end{frame}

\begin{frame}
\frametitle{COW}
\begin{itemize}
  \item<1-> Copy On Write - никогда не перезаписывать данные:
    \begin{itemize}
      \item вместо перезаписи на месте мы можем создать копию и обновить ее;
      \item нужно атомарно обновить ссылку с оригинала на обновленную копию;
      \item запись одного блока диска атомарна;
    \end{itemize}
  \item<2-> Деревья дружественная, обычно, к COW структура данных:
    \begin{itemize}
      \item используя проактивные разделения и слияния узлов сравнительно легко реализовать COW B+-дерево;
      \item нужно копировать только путь от корня, до измененного листа;
      \item подмена оригинала копией - подмена указателя на корень;
      \item Btrfs - ФС построенная вокруг COW B+-деревьев;
    \end{itemize}
\end{itemize}
\end{frame}
